\input{setup}

\title{L03 Build Tools}

\begin{document}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\section{Scripts}

\begin{frame}<1>[label=learning outcomes]
	\frametitle{Learning Outcomes}
	After successful completion of L03 \\
	students will be able to

	\begin{itemize}
	\item make small modifications in (build) scripts
	\item remember basics of testing in FLOSS
	\end{itemize}
\end{frame}

\begin{frame}[fragile,label=portable shell scripts]
	\frametitle{Portable Shell Scripts}

	\begin{itemize}[<+-| alert@+>]
	\item can use \verb+#!/bin/sh+ as shebang
	\item use another shell as shebang if they are not portable
	\item use a minimal subset of bash, zsh, ...
	\item can be checked with \verb+make run_shellcheck+
	\end{itemize}
\end{frame}

\begin{frame}[fragile]
	\frametitle{Reformatting (1)}

	Serial variant of scripts/dev/reformat-all

	\begin{lstlisting}[language=sh]
#!/bin/sh
#
# @author Klemens
# @brief Calls all other reformat scripts
# @date 29.03.2019
# @tags reformat

DEV_SCRIPTS_DIR=$(dirname "$0")
. "${DEV_SCRIPTS_DIR}/include-common"

cd "$SOURCE"

reformat() {
	reformat=$1
	shift
	\end{lstlisting}
\end{frame}

\begin{frame}[fragile]
	\frametitle{Reformatting (2)}

	\begin{lstlisting}[language=sh]
	echo "starting $reformat ..."
	"$reformat" "$@"
	echo "finished $reformat"
}

IFS='
'
for reformat in $(ls "$DEV_SCRIPTS_DIR"/reformat-*); do
	[ "$(basename "$reformat")" = "reformat-all" ] && continue
	reformat "$reformat" "$@"
done\end{lstlisting}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\section{Build Scripts}

\begin{frame}[label=build script goals]
	\frametitle{Goals}

	Build tools:

	\begin{itemize}[<+-| alert@+>]
	\item (cross-)compile the software
	\item generate documentation or other files
	\item run tests or build server scripts
	\item create packages
	\end{itemize}
\end{frame}

\begin{frame}<1>[label=generation]
	\frametitle{Generation}

	How build tools typically:

	\begin{itemize}[<+-| alert@+>]
	\item e.g.\ automake generates \texttt{./configure} shell scripts, which generates Makefiles
	\item e.g.\ CMake generates Makefiles, Ninja or project files of various IDEs
	\item other build tools directly invoke the compiler
	\end{itemize}

	\only<10>{
	\begin{task}
	Which build tool do you know?
	How does it work?
	\end{task}
	}
\end{frame}

\begin{frame}
	\frametitle{CMake}

	Elektra used automake and later switched to CMake.

	\vspace{1cm}

	CMake

	\begin{itemize}[<+-| alert@+>]
	\item cross-platform
	\item supports various programming languages
	\item has extensive modules for finding many tools and libraries
	\item see \texttt{scripts/cmake} of Elektra's repo
	\item \texttt{ctest} as test runner
	\item \texttt{cpack} for creating packages
	\end{itemize}
\end{frame}

\begin{frame}[fragile]
	\frametitle{Different Configurations}

	Common variants of how to run cmake are in \texttt{scripts/dev/configure-*}

	\begin{lstlisting}[language=sh]
cmake \
	-DPLUGINS="ALL" \
	-DTOOLS="ALL" \
	-DENABLE_DEBUG="OFF" \
	-DENABLE_LOGGER="OFF" \
	.\end{lstlisting}
\end{frame}

\begin{frame}
	\frametitle{Example: Elektra Plugins}

	\begin{itemize}[<+-| alert@+>]
	\item only \texttt{add_plugin}\footnote{implemented and documented in scripts/cmake/Modules/LibAddPlugin.cmake} needed in CMakeLists.txt
	\item README.md contains instructions when to add a plugin by looking at infos/provides and also infos/status
	\item \texttt{cmake -DPLUGINS="ALL;-EXPERIMENTAL"} excludes plugins which have EXPERIMENTAL in infos/status
	\item README.md also gets included in the plugin's code
	\end{itemize}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\section{Test Tools}

\begin{frame}[label=test runner]
	\frametitle{Test Runner}

	using ctest:

	\begin{itemize}
	\item valgrind
	\item ASAN
	\item AFL (not executed by ctest)
	\end{itemize}
\end{frame}

\begin{frame}[fragile]
	\frametitle{Environment}

	Run Elektra from the build folder via \texttt{scripts/dev/run_env}.
	Basically does:

	\begin{lstlisting}[language=sh]
# common configure script
export SCRIPTS_DIR="${ELEKTRA_DIR}/scripts/dev"
. "${SCRIPTS_DIR}/include-common"

export PATH="$BUILD/bin:$SCRIPTS_DIR:$PATH"
export KDB_EXEC_PATH="$COMMON_PATH:$KDB_EXEC_PATH"
export LD_LIBRARY_PATH="$BUILD/lib:$LD_LIBRARY_PATH"
export MANPATH="$SOURCE/doc/man:$MANPATH"
export CLASSPATH="$CLASSPATH:$BUILD/lib/libelektra.jar"

export PS1="[DEV] $PS1"\end{lstlisting}
\end{frame}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\section{Meeting}

\subsection{Recapitulation}

\againframe<2>{learning outcomes}

\begin{frame}
	\frametitle{Portable Shell Scripts}

	What is a shebang?

	Which subset is available?
\end{frame}
\againframe<10>{portable shell scripts}

\begin{frame}
	\frametitle{Goals}

	What are the goals of build tools?
\end{frame}
\againframe<10>{build script goals}

\begin{assignment}
	\begin{task}
	Break.
	\end{task}
\end{assignment}

\againframe<10>{generation}

\begin{frame}
	\frametitle{Test Runner}

	Which test runner is being used in Elektra?
	Which different tests does it execute?
\end{frame}
\againframe<10>{test runner}

\begin{frame}
	\frametitle{Docker}

	Reformatting\&Test execution in Docker

	Did the tutorials work?

	A. Yes \\
	B. No \\
	C. Didn't try \\
	D. Didn't understand
\end{frame}

\begin{assignment}
	\begin{task}
	Break.
	\end{task}
\end{assignment}


\subsection{Assignments}

\begin{assignment}
	\frametitle{Team}
	Teamsize: 1-3

	\begin{task}
	Please keep Teams up-to-date in Wiki.
	\end{task}
\end{assignment}

\begin{assignment}
	\frametitle{H2}

	\begin{task}
	Problems on specific issues or PRs?
	\end{task}
\end{assignment}

\begin{assignment}
	\frametitle{P1}

	\begin{task}
	Reviews. Deadline extention.
	\end{task}
\end{assignment}

\begin{frame}
	\frametitle{Feedback}

	\hfill \includegraphics[width=2cm]{pics/feedback.png}
	\vspace{-1cm}
	\begin{itemize}
		\item Difficulties in H2?
		\item ECTS breakdown realistic?
	\end{itemize}
\end{frame}

\subsection{Preview}

\begin{frame}
	\frametitle{L04 Continuous Integration}

	L03 quiz was at wrong place
\end{frame}


\end{document}
