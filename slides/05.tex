\input{setup}

\date{15.05.2018}

\begin{document}

\renewcommand{\enquote}[1]{\emph{``#1''}} % Cannot be done earlier

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{frame}
	\titlepage
	\doclicenseThis
\end{frame}


\begin{frame}
	Lecture is every week Wednesday 09:00 - 11:00.

	\begin{description}
		\item[06.03.2019:] {\color{gray}topic, teams}
		\item[13.03.2019:] {\color{gray}TISS registration, initial PR}
		\item[20.03.2019:] {\color{gray}other registrations, guest lecture}
		\item[27.03.2019:] {\color{gray}PR for first issue done, second started}
		\item[03.04.2019:] {\color{gray}first issue done, PR for second}
		\item[10.04.2019:] {\color{gray}mid-term submission of exercises}
		\item[08.05.2019:] {\color{gray}different location: Complang Libary}
		\item[15.05.2019:]
		\item[22.05.2019:] all 5 issues done
		\item[29.05.2019:]
		\item[05.06.2019:] final submission of exercises
		\item[12.06.2019:]
		\item[19.06.2019:] last corrections of exercises
		\item[26.06.2019:] exam
	\end{description}
\end{frame}

\begin{assignment}
	\frametitle{Tasks for today}
	(until 15.05.2019 23:59)

	\begin{task}
	Fourth PR done, PR for fifth issue created.
	\end{task}
\end{assignment}

\begin{assignment}
	\frametitle{Tasks for next week}
	(until 22.05.2019 23:59)

	\begin{task}
	All issues done.
	\end{task}

	\begin{task}
	Continue teamwork and homework.
	\end{task}
\end{assignment}

\begin{frame}
	\frametitle{Popular Topics}
	\vspace{-0.55cm}
	\setlength{\columnsep}{-1.3cm}
	\raggedright
	\begin{multicols}{2}
	\begin{description}
	\item[14] tools
	\item[9] {\color{red} testability}
	\item[9] {\color{orange} code-generation}
	\item[7] context-awareness
	\item[6] {\color{red} specification}
	\item[6] misconfiguration
	\item[6] {\color{gray} complexity reduction}
	\item[5] validation
	\item[5] {\color{red} points in time} % (early detection)
	\item[5] error messages
	\item[5] {\color{gray} auto-detection}
	\item[4] user interface
	\item[4] {\color{red} introspection}
	\item[4] design
	\item[4] cascading
	\item[4] {\color{red} architecture of access}
	\item[3] {\color{gray} configuration sources}
	\item[3] {\color{gray} config-less systems}
	\item[2] secure conf
	\item[2] {\color{gray} architectural decisions}
	\item[1] push vs.\ pull
	\item[1] infrastructure as code
	\item[1] full vs.\ partial
	\item[1] convention over conf %iguration
	\item[1] CI/CD
	\item[0] documentation
	\end{description}
	\end{multicols}
\end{frame}



\begin{frame}
	\frametitle{Goals for today}
	\textit{learning outcome:}
	\begin{itemize}
	\item evaluate a configuration system and decide about
	\begin{itemize}
	\item use of code generation (recapitulation)
	\item use of system-wide introspection
	\item testability
	\item time of validation
	\end{itemize}
	\end{itemize}
\end{frame}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\section{Introspection}

\subsection{}

\begin{frame}
	\frametitle{Introspection (Recapitulation)}
	\begin{alertblock}{Question}
	What can introspection offer?
	\end{alertblock}

	\pause
	\begin{itemize}
	\item unified get/set access to (meta*)-key/values
	\item access via applications, CLI, GUI, web-UI, ...
	\item access via any programming language (similar to file systems)
	\item GUI, web-UI can semantically interpret metadata
	\end{itemize}
\end{frame}

\begin{frame}[fragile]
	\frametitle{Internal Specification}

	For example, OWNER:
	\begin{code}[gobble=4,language=Java]
	import org.aeonbits.owner.Config;

	public interface ServerConfig extends Config {
		int port();
		String hostname();
		@DefaultValue("42")
		int maxThreads();
	}
	\end{code}
\end{frame}

\begin{frame}
	\begin{alertblock}{Question}
	Why do we need an external specification?
	\end{alertblock}

	\pause
	\vspace{1em}

	\textbf{Introspection}:
	\begin{itemize}
	\item needed as communication of producers and consumers of configuration
	\item the foundation for any advanced tooling like configuration management tools
	\item essential for \intro[no-futz computing]{no-futz computing}~\citet{holland2001nofutz}
	\end{itemize}
\end{frame}

\begin{frame}[fragile]
	\frametitle{External Specification}

	\begin{code}[gobble=4]
	[port]
	type:=long
	[hostname]
	default:=42
	[threads/max]
	type:=long
	\end{code}

	\vspace{1em}

	Advantages:
	\pause
	\begin{itemize}
	\item are read and writable by other applications (introspection)
	\item we can generate the internal specification (code generation)
	\item we fulfill needs for configuration management tools
	\end{itemize}
\end{frame}

\begin{frame}
	Other Artefacts (Recapitulation):

	\pause

	\begin{itemize}
	\item examples (e.g., defaults)
	\item documentation
	\item auto-completion/syntax highlighting/IDE support
	\item tooling (GUI, Web UI)
	\item validation code
	\item parsing code (e.g., command-line parsing)
	\item configuration management tool code
	\item configuration access APIs
	\end{itemize}
\end{frame}

\begin{frame}
	\frametitle{KeySet (Recapitulation)}

	The common data structure between plugins:
	\vspace{1cm}

	\includegraphics{keyset}
\end{frame}

%HERE

\begin{frame}[fragile]
	\frametitle{KeySet Generation (Recapitulation)}
	\begin{alertblock}{Question}
	Idea: What if the configuration file format grammar describes source code?
	\end{alertblock}

	\pause

	key ^spec:/slapd/threads/listener^, with the configuration value ^4^ and the property $\property{default} \mapsto 1$:

	\begin{code}[gobble=4,language=Cpp]
	ksNew (keyNew ("spec:/slapd/threads/listener",
		       KEY_VALUE, "4",
		       KEY_META, "default", "1",
		       KEY_END),
	       KS_END);
	\end{code}

	\begin{alertblock}{Finding}
	We get source code representing the settings.
	\end{alertblock}
\end{frame}

\begin{frame}
	\frametitle{Possible Properties (Recapitulation)}

	\pause

	For example, SpecElektra has following properties:
	\begin{description}
	\item[type] represents the type to be used in the emitted source code.
	\item[opt] is used for short command-line options to be copied to the namespace \namespace{proc}.
	\item[opt/long] is used for long command-line options, which differ from short command-line options by supporting strings and not only characters.
	\item[readonly] yields compilation errors when developers assign a value to a contextual value within the program.
	\item[default] enables us to start the application even if the backend does not work.
	\end{description}
\end{frame}

\begin{frame}
	\frametitle{(Recapitulation)}
	\begin{alertblock}{Question}
	Introspection vs. Code Generation?
	\end{alertblock}

	\pause
	\vspace{0.5em}

	\setbeamersize{description width=1cm}
	\begin{description}
	\item[$-$] more techniques for performance improvements with code generation
	\item[$+$] specification can be updated live on the system without recompilation
	\item[$+$] tooling has generic access to all specifications
 	\item[$+$] new features the key database (e.g., better validation) are immediately available consistently
	\end{description}

	\vspace{0.5em}

	\begin{alertblock}{Implication}
	We generally prefer introspection, except for a very thin configuration access API.
	\end{alertblock}
\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\section{Testability}

\subsection{}

\begin{frame}
	\begin{alertblock}{Question}
	What do we want to test?
	\end{alertblock}

	\pause
	\begin{itemize}
	\item That settings do what they should (devs and admins)
	\item That settings are properly validated (devs~\cite{xu2013blame})
	\item Regression tests~\cite{qu2008configuration}
	\pause
	\vspace{1em}
	\item Are all settings implemented?
	\item Are all settings used in tests?
	\item Are there unused settings in the code?
	\end{itemize}
\end{frame}

\begin{frame}
	Matt Welsh from Google wrote in 2013:\footnote{What I wish systems researchers would work on. Retrieved from http://matt-welsh.blogspot.com/2013/05/what-i-wish-systems-researchers-would.html.}

	\vspace{2em}

	\emph{``Of course we have extensive testing infrastructure, but the ‘hard’ problems always
	come up when running in a real production environment, with real traffic and real
	resource constraints. Even integration tests and canarying are a joke compared to
	how complex production-scale systems are.''}
\end{frame}

\lstDeleteShortInline^
\begin{frame}
	\frametitle{\citet{jin2014configurations}}

	\begin{itemize}
	\item Wants to improve configuration-aware testing and debugging
	\item Manual investigations for three applications
	\item Finds 1957 settings in Firefox ($2^{846} * 3^{1111}$) and \\
		36322 in LibreOffice ($2^{4433} * 3^{31889}$)
	\item Finds unused settings: settings only in the source code
	\item Finds unsynchronized configuration settings
	\end{itemize}

	\begin{requirement}
	Configuration setting traceability is a necessity.
	\end{requirement}

	\begin{alertblock}{Idea}
	Code generation helps to trace settings and to find unused settings.
	\end{alertblock}
\end{frame}
\lstMakeShortInline[postbreak=,keywordstyle={},showspaces=no]^
%XXX

%Other requirements they have:
%\begin{frame}
%	\frametitle{Requirements \cite{jin2014configurations}}
%	\begin{requirement}
%	Configuration Modeling Should Merge Multiple Layers.
%	\end{requirement}
%	\begin{requirement}
%	Analysis Tools Need to Cross the Programming Language Barrier
%	\end{requirement}
%	\begin{requirement}
%	Configuration State Capture or Approximation Techniques are Needed
%	\end{requirement}
%\end{frame}

\begin{frame}
	\frametitle{Testing by developers:}
	\begin{itemize}[<+-| alert@+>]
	\item ConfErr~\cite{keller2008conferr} uses models of key board layout, psychology and linguistics.
	Tool injects possible misconfiguration.
	\item Spex~\cite{xu2013blame} analyzes the source code to find misconfigurations.
	As by-product it extracts internal specifications (including transformation bugs).
	\item External specification can be directly used to generate test cases.
	\item Find unused configuration settings.
	\end{itemize}
\end{frame}

\begin{assignment}
	\begin{task}
	Break.
	\end{task}
\end{assignment}


\begin{frame}
	\frametitle{Find Unused Settings}

	%contextual value not yet introduced:
	%\ExecuteMetaData[../book/implications.tex]{algorithm-first}
	The first (optional) step of the algorithm is:
	\begin{itemize}
	\item Run all tests with code coverage.
	\item Check if generated code is executed.
	\item If it is, we know that the configuration setting is used in a test case.
	Otherwise, we know it is not tested by the test suite.
	All these untested configuration settings are remembered as candidates for the second step.
	\end{itemize}
\end{frame}

\begin{frame}[fragile]
	\small
	\fontsize{10}{0}\selectfont
	\begin{code}[gobble=4,language=Cpp]
	KeySet findUnusedSettings (KeySet untestedSettings,
				   KDB kdb,
				   Builder build)
	{
	   KeySet unusedSettings = {};
	   KeySet configurationSpecification;
	   kdb.get (configurationSpecification);

	   for (candidate: untestedSettings)
	   {
	       configurationSpecification.remove (candidate);
	       kdb.set (configurationSpecification);
	       build.recompile ();
	       if (build.wasSuccessful ())
	       {
	          unusedSettings.append (candidate);
	       }
	       configurationSpecification.append (candidate);
	   }

	   kdb.set (configurationSpecification);
	   return unusedSettings;
	}
	\end{code}
\end{frame}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\section{Early Detection}

\subsection{}

\begin{frame}
	\frametitle{When are settings used?}
	\begin{description}[<+-| alert@+>]
	\item[Implementation-time] configuration accesses \index{implementation-time}
	are hard-coded settings in the sou\-rce code repository.
	For example, architectural decisions~\cite{zdun2007patterns} lead to impl\-ementation-time settings.

	\item[Compile-time] configuration accesses \index{compile-time}
	are configuration accesses resolved by the build system while compiling the code.

	\item[Deployment-time] configuration accesses \index{deployment-time}
	are configuration accesses while the software is installed.

	\item[Load-time] configuration accesses \index{load-time}
	are configuration accesses during the start of applications.

	\item[Run-time] configuration accesses \index{run-time}
	are configuration accesses during execution not limited to the startup procedure.
	\end{description}
\end{frame}

\begin{frame}
	\frametitle{Latent Misconfiguration}
	Phases when we can detect misconfigurations:
	\begin{itemize}[<+-| alert@+>]
	\item Compilation stage in configuration management tool
	\item Writing configuration settings on nodes
	\item Starting applications (load-time)
	\item When configuration setting is actually used (run-time)
	\end{itemize}

	\pause[\thebeamerpauses]

	\begin{alertblock}{Problem}
	More context vs. easier to detect and fix.
	\end{alertblock}
\end{frame}

\begin{frame}
	As shown by \citet{xu2016early}:
	\begin{itemize}[<+-| alert@+>]
	\item \p{12} -- \p{39} configuration settings are not used at all during initialization.
	\item Applications often have latent misconfigurations (\p{14} -- \p{93})
	\item Latent misconfigurations are particular severe (\p{75} of high-severity misconfigurations)
	\item Latent misconfiguration needs longer to diagnose
	\end{itemize}
\end{frame}

\begin{frame}
	\frametitle{Checkers as plugins}

	Using checkers as plugins exclude whole classes of errors such as:
	\begin{itemize}[<+-| alert@+>]
	\item Invalid file paths using the plugin \plugin{path}.
	\item Invalid IP addresses or host names using the plugins \plugin{network} or \plugin{ipaddr}.
	\end{itemize}

	\pause[\thebeamerpauses]
	Because the checks occur before the resources are actually used, the checks are subject to race conditions.\footnotemark
	\only<3->{\footnotetext[1]{For example, a path that was present during the check, can have been removed when the application tries to access it.}}

	\pause
	In some situations facilities of the operating system help\footnotemark, in others we have fundamental problems.\footnotemark
	\only<4>{\footnotetext[2]{For example, we open the file during the check and pass \texttt{/proc/<pid>/fd/<fd>} to the application. This file cannot be unlinked, but unfortunately the file descriptor requires resources.}}
	\only<4>{\footnotetext[3]{For example, if the host we want to reach has gone offline after validation.}}
\end{frame}

\begin{frame}[fragile]
	\frametitle{Example~\cite{xu2016early}}

	Squid uses ^diskd_program^ but not before requests are served.
	Latent misconfiguration caused 7h downtime and 48h diagnosis effort.

	\pause

	\begin{alertblock}{Finding}
	Configuration from all externals programs need to be checked, too.
	\end{alertblock}
\end{frame}


\begin{frame}
	\frametitle{Conclusion}

	\begin{itemize}[<+-| alert@+>]
	\item provide external specifications for other tooling and configuration management
	\item use code generation to keep internal specifications consistent with external specifications
	\item implement checkers as plugins
	\item execute checkers as early as possible,
	also for external programs executed later
	\item keep important resources allocated after checking
	\end{itemize}

\end{frame}


\begin{frame}
	\frametitle{Preview}

	\begin{itemize}
	\item Documentation
	\item Notification
	\item Context-Awareness
	\end{itemize}
\end{frame}




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% 
\nocite{raab2017introducing}

\appendix

\begin{frame}[allowframebreaks]
	\bibliographystyle{plainnat}
	\bibliography{../shared/elektra.bib}
\end{frame}

\end{document}


